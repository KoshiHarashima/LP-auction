# LP-auction
線形計画による最適オークション機構設計

## 概要
本プロジェクトは、1人m財のオークションにシナジーを考慮した最適メカニズムを線形計画法（LP）で実装したものです。
特に、`rochet_chone_auction.ipynb`では、**1人2財1シナジー**のケースを扱います。

## 問題設定
### 基本構造
- **1人2財1シナジー**の問題を、**1人3財の問題 + シナジーの配分制約**として再定式化します
- 財a、財b、シナジーαの3つの選択肢を考えます
- 各タイプの評価値（x_a, x_b, x_α）は分布から抽出されます

### 実装方法
- **Primal問題**: Rochet-Choné表現による利潤最大化
- **Dual問題**: Kash-Frongillo型の最適輸送問題（誤差評価と収束判定に使用）
- **ソルバー**: Gurobi（必須）
- **反復的制約追加アルゴリズム**: 局所的なIC制約（ic-local）から始め、最適解を求めた後、違反している大局的なIC制約を検出して追加する。違反がなくなるまで反復する。これにより、最初からすべての大局的IC制約を含める必要がなくなり、計算効率が向上する。

## 離散化（グリッドの構築）
連続的な型空間を離散化するため、テンソルグリッドを使用します：
- **x[j]**: グリッド点jでの座標ベクトル (x_a, x_b, x_α) ∈ [0,1]³
- **w[j]**: グリッド点jでの型分布の重み（Product-Beta分布から計算）

## Rochet-Choné Primal問題

### 変数
- **u[j]**: グリッド点jでの interim utility（効用）≥ 0
- **p[l,j]**: 配分確率のベクトル（uの勾配）
  - l = 0: 財aの配分確率
  - l = 1: 財bの配分確率
  - l = 2: シナジーαの配分確率
  - 各要素は 0 ≤ p[l,j] ≤ 1

### 目的関数
```
max Σ_j w[j] ((p(j)・x(j)) - u(j))
```

ここで、**p(j)・x(j)** は3次元ベクトルの内積：
```
p(j)・x(j) = p[0,j]・x[j,0] + p[1,j]・x[j,1] + p[2,j]・x[j,2]
```

### 制約

#### 1. 非負性
全てのタイプxで、0以上
```
u(x) ≥ 0  (全てのxで)
```
実装では、変数の定義時に `u[j] ≥ 0` として設定。

#### 2. Convexity
効用関uが凸関数であることを保証
```
u(i) ≥ u(j) + p(j)・(x(i) - x(j))  (全てのタイプの組み(i, j)に関して)
```

これは、タイプiの参加者がタイプjを報告するインセンティブがないことを意味します。

#### 3. 1-Lipschitz制約
各財の配分確率が有界であることを保証：
```
0 ≤ p[l,j] ≤ 1  (l財で点jの傾き)
```
実装では、変数の定義時に `0 ≤ p[l,j] ≤ 1` として設定。

#### 4. シナジーの配分制約
シナジーαの配分確率が、財aと財bの配分確率と整合的であることを保証：
```
p[2,j] ≤ p[0,j]  (u_α(x) ≤ u_a(x))
p[2,j] ≤ p[1,j]  (u_α(x) ≤ u_b(x))
p[2,j] ≥ p[0,j] + p[1,j] - 1  (u_α(x) ≥ u_a(x) + u_b(x) - 1)
```

## Kash-Frongillo Dual問題
Dual問題は最適輸送問題として定式化され、以下に使用されます：
- Primal解の誤差評価
- 解の収束判定


## Appendix
特に、`Appendix.ipynb`では、**1人3財4シナジー**のケースを扱います。同じように7財とシナジーの配分制約に分けて考えます。財a, 財b, 財c, α12, α23, α31, α123。  

最大化問題と非負性、Convexity、1-Lipschitz制約は同じ. 

シナジーの配分制約は, 以下である. 

```math
\begin{align}
&u_{\alpha_{1,2}}(x) \le u_{1}(x),\\
&u_{\alpha_{1,2}}(x) \le u_{2}(x),\\
&u_{\alpha_{1,2}}(x) \ge u_{1}(x) + u_{2}(x) - 1.\\ 
\\
&u_{\alpha_{2,3}}(x) \le u_{2}(x),\\
&u_{\alpha_{2,3}}(x) \le u_{3}(x),\\
&u_{\alpha_{2,3}}(x) \ge u_{2}(x) + u_{3}(x) - 1. \\
\\
&u_{\alpha_{3,1}}(x) \le u_{3}(x),\\
&u_{\alpha_{3,1}}(x) \le u_{1}(x),\\
&u_{\alpha_{3,1}}(x) \ge u_{3}(x) + u_{1}(x) - 1. \\
\\
&u_{\alpha_{1,2,3}}(x) \le u_{1}(x),\\
&u_{\alpha_{1,2,3}}(x) \le u_{2}(x),\\
&u_{\alpha_{1,2,3}}(x) \le u_{3}(x),\\
&u_{\alpha_{1,2,3}}(x) \ge u_{\alpha_{1,2}}(x) + u_{3}(x) -1\\
&u_{\alpha_{1,2,3}}(x) \ge u_{\alpha_{2,3}}(x) + u_{1}(x) -1\\
&u_{\alpha_{1,2,3}}(x) \ge u_{\alpha_{3,1}}(x) + u_{2}(x) -1\\
&u_{\alpha_{1,2,3}}(x) \ge u_{\alpha_{1,2}}(x)+u_{\alpha_{2,3}}(x)+u_{\alpha_{3,1}}(x) -u_{1}(x) -u_{2}(x) - u_{3}(x) + 1
\end{align}
```


## 2人の2財1シナジー
2人の参加者（i = 1, 2）がそれぞれ2財1シナジーを持つケースを扱います。

### 問題設定
- **参加者1**: 型 (x₁_a, x₁_b, x₁_α) ∈ [0,1]³
- **参加者2**: 型 (x₂_a, x₂_b, x₂_α) ∈ [0,1]³
- 各参加者の型は独立に分布から抽出される
- メカニズムは両者の型の組み合わせ (x₁, x₂) に依存する

### 離散化
- **x₁[j₁]**: 参加者1のグリッド点j₁での座標ベクトル (x₁_a, x₁_b, x₁_α) ∈ [0,1]³
- **x₂[j₂]**: 参加者2のグリッド点j₂での座標ベクトル (x₂_a, x₂_b, x₂_α) ∈ [0,1]³
- **w₁[j₁]**: 参加者1のグリッド点j₁での型分布の重み
- **w₂[j₂]**: 参加者2のグリッド点j₂での型分布の重み
- 型の組み合わせ (j₁, j₂) の重みは w₁[j₁] × w₂[j₂]

### Primal問題

i(1と2)さんと、jがグリッドのindex（5だったら125個ある）

#### 変数
- **u₁[j]**: 参加者1がグリッド点jでの interim utility（スカラー）≥ 0
- **u₂[j]**: 参加者2がグリッド点jでの interim utility（スカラー）≥ 0
- **p₁[j]**: 参加者1の配分確率のベクトル（u₁の勾配）$\mathbf{p}_1 = \nabla u_1$
  - ベクトルの各成分: p₁[j, 0] (財a), p₁[j, 1] (財b), p₁[j, 2] (シナジーα)
- **p₂[j]**: 参加者2の配分確率のベクトル（u₂の勾配）$\mathbf{p}_2 = \nabla u_2$
  - ベクトルの各成分: p₂[j, 0] (財a), p₂[j, 1] (財b), p₂[j, 2] (シナジーα)
- **x₁[j]**: 参加者1のグリッド点jでの型ベクトル $\mathbf{x}_1(j)$
- **x₂[j]**: 参加者2のグリッド点jでの型ベクトル $\mathbf{x}_2(j)$
- **w[j]**: グリッド点jでの型分布の重み

#### 目的関数
```math
\max \sum_{i=1}^{2} \sum_{j} w_j (\mathbf{u}_{i,j}^{\top} \mathbf{x}_j - u_{ij})
```

ここで：
- $\mathbf{u}_{i,j}^{\top} \mathbf{x}_j$ はベクトルの内積（$\mathbf{u}_{i,j}$は$\mathbf{p}_i(j)$を意味する）
- 実際には $\mathbf{p}_1(j)^{\top} \mathbf{x}_1(j) - u_1(j)$ と $\mathbf{p}_2(j)^{\top} \mathbf{x}_2(j) - u_2(j)$ の和

#### 制約

##### 1. IC（インセンティブ両立性）
各参加者について、自分の型を正直に報告することが最適であることを保証：

**参加者1について:**
```math
u_1(i) \ge u_1(j) + \mathbf{p}_1(j)^{\top}(\mathbf{x}_1(i) - \mathbf{x}_1(j)) \quad \forall i, j
```

**参加者2について:**
```math
u_2(i) \ge u_2(j) + \mathbf{p}_2(j)^{\top}(\mathbf{x}_2(i) - \mathbf{x}_2(j)) \quad \forall i, j
```

##### 2. 1-Lipschitz制約
各財の配分確率が有界であることを保証：
```math
0 \le u_{1,\{k\}} \le 1, \quad 0 \le u_{2,\{k\}} \le 1 \quad \forall k \in \{1\}, \{2\}, \{3\}
```

ここで、$\{1\}, \{2\}, \{3\}$はそれぞれ財a、財b、シナジーαに対応。

##### 3. IR（個人合理性）
```math
u_1(x) = 0, \quad u_2(x) = 0 \quad \forall x
```

##### 4. シナジー条件
各参加者について、シナジーαの配分確率が財aと財bの配分確率と整合的であることを保証：

**参加者1について:**
```math
\begin{align}
u_{1,\alpha}(x) &\le u_{1,a}(x) \\
u_{1,\alpha}(x) &\le u_{1,b}(x) \\
u_{1,\alpha}(x) &\ge u_{1,a}(x) + u_{1,b}(x) - 1
\end{align}
```

**参加者2について:**
```math
\begin{align}
u_{2,\alpha}(x) &\le u_{2,a}(x) \\
u_{2,\alpha}(x) &\le u_{2,b}(x) \\
u_{2,\alpha}(x) &\ge u_{2,a}(x) + u_{2,b}(x) - 1
\end{align}
```

##### 5. Implementability（凸結合条件）
Appendix参照。以下のような制約が追加される：

```math
\begin{align}
0 &\le u_{1,\{\alpha\}} \le 1, \quad 0 \le u_{2,\{\alpha\}} \le 1 \\
\max\{0, u_{1,\{\alpha\}} - u_{1,\{a\}}, u_{2,\{\alpha\}} - u_{2,\{b\}}\} &\le \min\{u_{1,\{a\}} - u_{1,\{\alpha\}}, u_{2,\{b\}} - u_{2,\{\alpha\}}, 1\} \\
\max\{0, u_{1,\{a,b,\alpha\}} - u_{1,\{b\}}, u_{2,\{a,b,\alpha\}} - u_{2,\{a\}}\} &\le \min\{u_{1,\{b\}} - u_{1,\{a\}}, u_{2,\{a\}} - u_{2,\{a\}}, 1\} \\
u_{1,\{a\}} + u_{1,\{b\}} + u_{2,\{a\}} + u_{2,\{b\}} - u_{1,\{\alpha\}} - u_{2,\{\alpha\}} &\le 1
\end{align}
```

補助変数：
```math
\begin{align}
a_7^{\min} &= \max\{0, u_{1,\{a\}} - u_{1,\{\alpha\}} - 1, u_{2,\{b\}} - u_{2,\{\alpha\}} - 1\} \\
a_8^{\min} &= \max\{0, u_{1,\{b\}} - u_{1,\{\alpha\}} - 1, u_{2,\{a\}} - u_{2,\{\alpha\}} - 1\}
\end{align}
```

追加制約：
```math
u_{1,\{a\}} + u_{1,\{b\}} + u_{2,\{a\}} + u_{2,\{b\}} - u_{1,\{\alpha\}} - u_{2,\{\alpha\}} \le 1 + a_7^{\min} + a_8^{\min}
```

### 実装上の考慮事項
- グリッドサイズが大きくなると、変数の数が O(N₁³ × N₂³) となり、計算量が急増する
- 反復的制約追加アルゴリズムが特に重要（全てのIC制約を最初から含めると制約数が膨大になる）
- 各参加者の型空間が独立であることを利用して、効率的な実装が可能


## 実装上の注意事項
- **フォールバック処理はしない**: エラーが発生した場合は適切に処理し、フォールバックは実装しない
- jupyternotebookには, コメントは最小限にする. 
- **Gurobiソルバー必須**: アカデミックライセンスを使用する場合は、`gurobi.lic`をホームディレクトリに配置